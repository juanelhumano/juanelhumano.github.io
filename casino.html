<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Perrón</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Lato', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        h1, h2, h3, .brand-font { font-family: 'Cinzel', serif; }
        .gold-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .gold-border { border: 2px solid #b38728; box-shadow: 0 0 10px rgba(179, 135, 40, 0.5); }
        .poker-table {
            background-color: #35654d;
            background-image: radial-gradient(#407a5d 20%, transparent 20%), radial-gradient(#407a5d 20%, transparent 20%);
            background-size: 50px 50px; background-position: 0 0, 25px 25px;
            border: 15px solid #3e2723; border-radius: 50px;
            box-shadow: inset 0 0 50px #000;
        }
        .card {
            width: 60px; height: 90px; background: white; border-radius: 5px;
            display: flex; justify-content: center; items-align: center;
            font-weight: bold; font-size: 1.2rem; color: black;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5); position: relative;
            transition: transform 0.2s; user-select: none;
        }
        .card.red { color: #d32f2f; }
        .card.wild { color: #9333ea; border: 2px solid #a855f7; box-shadow: 0 0 10px #a855f7; }
        .card.hidden-card {
            background: #b38728;
            background-image: repeating-linear-gradient(45deg, #aa771c 0, #aa771c 10px, #b38728 10px, #b38728 20px);
            color: transparent;
        }
        .card-btn { transition: all 0.3s ease; cursor: pointer; }
        .card-btn:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(179, 135, 40, 0.4); }
        .hidden-screen { display: none !important; }
        
        .animate-deal { animation: deal 0.5s ease-out forwards; }
        @keyframes deal { from { transform: translateY(-200px) scale(0.5); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .discard-selected {
            transform: translateY(-20px);
            opacity: 0.7;
            border: 2px solid #ef4444; 
        }

        .swap-hand-selected {
             transform: translateY(-15px);
             border: 2px solid #ef4444;
        }
        .swap-comm-selected {
             transform: translateY(15px);
             border: 2px solid #3b82f6;
        }
        
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: #1e293b; }
        #chat-messages::-webkit-scrollbar-thumb { background: #ca8a04; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-950 min-h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="w-full bg-slate-900 border-b border-yellow-600/30 p-4 flex justify-between items-center z-50">
        <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
            <i class="fa-solid fa-crown text-yellow-500 text-2xl"></i>
            <span class="text-xl font-bold brand-font gold-text">CASINO PERRÓN</span>
        </div>
        <div id="connectionStatus" class="text-xs text-red-500 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div> Offline
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 flex flex-col justify-center items-center relative">
        
        <!-- SCREEN 1: LANDING -->
        <div id="screen-landing" class="w-full max-w-md text-center space-y-6">
            <div class="mb-4">
                <i class="fa-solid fa-dice text-6xl text-yellow-600 mb-4 block"></i>
                <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 brand-font">Bienvenido</h1>
                <p class="text-slate-400">Donde la suerte muerde.</p>
            </div>
            
            <div class="bg-slate-900/80 p-8 rounded-xl gold-border backdrop-blur-sm">
                <label class="block text-left text-yellow-500 mb-2 font-bold">Tu Alias</label>
                <input type="text" id="usernameInput" placeholder="Ej: El Patrón" class="w-full bg-slate-800 text-white border border-slate-600 rounded p-3 mb-6 focus:outline-none focus:border-yellow-500 transition">
                <button onclick="goToSelection()" class="w-full bg-gradient-to-r from-yellow-700 to-yellow-500 text-slate-900 font-bold py-3 rounded hover:from-yellow-600 hover:to-yellow-400 transition shadow-lg">
                    ENTRAR AL CASINO
                </button>
            </div>
        </div>

        <!-- SCREEN 2: GAME SELECTION -->
        <div id="screen-selection" class="hidden-screen w-full max-w-6xl text-center">
            <h2 class="text-3xl gold-text mb-8 brand-font">Selecciona tu Mesa</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                
                <!-- Blackjack -->
                <div onclick="selectGame('blackjack')" class="card-btn bg-slate-900 border border-yellow-600 rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-yellow-500/10 group-hover:bg-yellow-500/20 transition"></div>
                    <img src="https://img.icons8.com/color/96/blackjack.png" alt="Blackjack" class="mx-auto mb-4 relative z-10 w-16 h-16">
                    <h3 class="text-xl font-bold text-white relative z-10">21 Blackjack</h3>
                    <p class="text-xs text-slate-400 mt-2 relative z-10">PvP. Regla Quintilla.</p>
                </div>

                <!-- Poker -->
                <div onclick="selectGame('poker')" class="card-btn bg-slate-900 border border-yellow-600 rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-yellow-500/10 group-hover:bg-yellow-500/20 transition"></div>
                    <img src="https://img.icons8.com/color/96/poker-hand.png" alt="Poker" class="mx-auto mb-4 w-16 h-16 relative z-10">
                    <h3 class="text-xl font-bold text-white relative z-10">Póker Draw</h3>
                    <p class="text-xs text-slate-400 mt-2 relative z-10">5 Cartas. Descarte.</p>
                </div>

                <!-- Texas -->
                <div onclick="selectGame('texas')" class="card-btn bg-slate-900 border border-yellow-600 rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-yellow-500/10 group-hover:bg-yellow-500/20 transition"></div>
                    <img src="https://img.icons8.com/color/96/chip.png" alt="Texas" class="mx-auto mb-4 w-16 h-16 relative z-10">
                    <h3 class="text-xl font-bold text-white relative z-10">Texas Hold'em</h3>
                    <p class="text-xs text-slate-400 mt-2 relative z-10">2 Cartas + Comunitarias.</p>
                </div>

                <!-- Viuda -->
                <div onclick="selectGame('viuda')" class="card-btn bg-slate-900 border border-yellow-600 rounded-xl p-6 relative overflow-hidden group">
                     <div class="absolute inset-0 bg-yellow-500/10 group-hover:bg-yellow-500/20 transition"></div>
                    <img src="https://img.icons8.com/color/96/spider.png" alt="Viuda" class="mx-auto mb-4 w-16 h-16 relative z-10">
                    <h3 class="text-xl font-bold text-white relative z-10">Viuda Negra</h3>
                    <p class="text-xs text-slate-400 mt-2 relative z-10">Intercambio y Toque.</p>
                </div>
            </div>
            <button onclick="showScreen('screen-landing')" class="mt-8 text-slate-500 hover:text-white underline">Cerrar Sesión</button>
        </div>

        <!-- SCREEN 3: LOBBY -->
        <div id="screen-lobby" class="hidden-screen w-full max-w-md text-center">
            <h2 id="lobby-title" class="text-3xl text-yellow-500 mb-2 brand-font">Sala</h2>
            
            <div id="lobby-controls" class="space-y-4">
                
                <!-- Create Options -->
                <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 hover:border-yellow-500 transition">
                    <h3 class="text-lg font-bold mb-4">Crear Sala Privada</h3>
                    
                    <div class="text-left bg-slate-900 p-3 rounded mb-4 space-y-3">
                        <div>
                            <label class="block text-slate-400 text-xs font-bold mb-1">APUESTA INICIAL ($)</label>
                            <input type="number" id="betInput" value="100" min="0" class="w-full bg-slate-800 text-white border border-slate-600 rounded p-2 text-right font-mono text-yellow-500">
                        </div>

                        <!-- Generic Wildcard Option (Available for Poker, Texas, Viuda) -->
                        <div id="wildcard-option" class="hidden">
                            <label class="flex items-center justify-between cursor-pointer">
                                <span class="text-white text-sm">¿Comodines Aleatorios?</span>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" id="wildcardToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 right-5"/>
                                    <label for="wildcardToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer checked:bg-yellow-500"></label>
                                </div>
                            </label>
                            <p class="text-xs text-slate-500 mt-1">Una carta al azar (ej: 7, K) será el comodín.</p>
                        </div>
                    </div>

                    <button onclick="createRoom()" class="w-full bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-2 rounded">
                        <i class="fa-solid fa-plus-circle mr-2"></i> CREAR
                    </button>
                </div>

                <div class="flex items-center justify-center py-2">
                    <span class="h-px bg-slate-700 w-full"></span><span class="px-2 text-slate-500 text-xs">O</span><span class="h-px bg-slate-700 w-full"></span>
                </div>

                <div class="bg-slate-800 p-6 rounded-lg border border-slate-700">
                    <h3 class="text-lg font-bold mb-2">Unirse a Sala</h3>
                    <div class="flex gap-2">
                        <input type="text" id="roomCodeInput" placeholder="CÓDIGO" class="w-full bg-slate-900 text-center text-white border border-slate-600 rounded p-2 uppercase tracking-widest">
                        <button onclick="joinRoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded font-bold">IR</button>
                    </div>
                </div>
                
                <button onclick="showScreen('screen-selection')" class="text-slate-500 hover:text-white underline text-sm">Cambiar Juego</button>
            </div>

            <div id="lobby-waiting" class="hidden-screen mt-4">
                <p class="text-xl text-white mb-2">Código: <span id="display-code" class="font-mono bg-slate-800 px-3 py-1 rounded border border-yellow-500/50 text-yellow-400">----</span></p>
                <p id="game-mode-display" class="text-xs text-yellow-500 mb-4 font-bold uppercase"></p>

                <div class="bg-slate-800/50 p-4 rounded-lg mb-4 text-left">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-2 border-b border-slate-700 pb-1">Jugadores</h3>
                    <ul id="players-list" class="space-y-1 text-sm font-bold"></ul>
                </div>
                <button id="btn-start" onclick="startGame()" class="hidden-screen w-full bg-green-700 hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg animate-pulse">
                    INICIAR PARTIDA
                </button>
                <p id="msg-waiting-host" class="text-slate-500 text-xs italic">Esperando al anfitrión...</p>
            </div>
        </div>

        <!-- SCREEN 4: GAME TABLE -->
        <div id="screen-game" class="hidden-screen w-full h-full flex flex-col items-center justify-center pt-4">
            
            <div class="w-full max-w-5xl flex justify-between items-start px-2 mb-2">
                <div class="bg-slate-900/80 px-4 py-1 rounded-full border border-yellow-600/30">
                     <span class="text-xs text-slate-400 block">POZO TOTAL</span>
                     <span id="pot-display" class="text-yellow-500 font-mono font-bold text-lg">$0</span>
                </div>
                
                <div id="game-status-bar" class="bg-black/60 px-6 py-2 rounded-full text-yellow-400 font-bold backdrop-blur-sm border border-yellow-600/30 text-sm">
                    Cargando...
                </div>

                <div id="wildcard-badge" class="hidden opacity-0 transition-opacity duration-500 flex flex-col items-center">
                     <div class="bg-purple-900/80 text-purple-200 text-xs px-3 py-1 rounded-t-lg font-bold">COMODÍN</div>
                     <div id="wild-card-display" class="bg-white text-black font-bold px-3 py-2 rounded-b-lg border-2 border-purple-500 text-xl shadow-[0_0_15px_rgba(168,85,247,0.5)]">
                         ?
                     </div>
                </div>
            </div>

            <!-- LAYOUT FIX: Added flex-col and justify-between to ensure spacing -->
            <div class="poker-table w-full max-w-5xl flex-grow relative m-2 rounded-[60px] flex flex-col justify-between p-4">
                
                <!-- TOP: Opponents Area -->
                <div id="opponents-area" class="flex justify-center gap-4 flex-wrap z-10 min-h-[100px]"></div>

                <!-- MIDDLE: Community Cards & Logo -->
                <div class="flex flex-col items-center justify-center my-4 z-0">
                    <div id="center-logo" class="opacity-10 text-4xl md:text-6xl text-black brand-font text-center leading-tight mb-2">CASINO<br>PERRÓN</div>
                    <!-- Community Cards Container -->
                    <div id="community-cards-container" class="flex gap-2 min-h-[90px] pointer-events-auto"></div>
                </div>

                <!-- BOTTOM: My Player Area -->
                <div class="self-center flex flex-col items-center relative z-10 mb-2">
                    <div id="my-score-container" class="flex items-center gap-2 mb-2">
                        <span class="text-xs text-slate-400 font-bold uppercase">Tu mano</span>
                        <div id="my-score-bubble" class="bg-slate-900 text-white px-3 py-1 rounded-full text-lg font-bold border border-slate-600 shadow-lg min-w-[40px] text-center">0</div>
                    </div>

                    <div id="poker-instructions" class="hidden-screen text-yellow-300 text-xs font-bold mb-1 animate-bounce">
                        <i class="fa-solid fa-arrow-down"></i> Toca las cartas que quieras DESCARTAR
                    </div>

                    <div class="relative">
                        <div id="my-hand" class="flex justify-center" style="min-height: 90px;"></div>
                    </div>

                    <div class="bg-slate-900 px-4 py-1 rounded-xl border-t-2 border-yellow-600 mt-2 shadow-xl flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-user text-yellow-500 text-xs"></i>
                            <span id="my-name-display" class="font-bold text-white text-sm">Yo</span>
                        </div>
                        <div class="border-l border-slate-700 pl-4 text-xs">
                             <span class="text-slate-400">Apuesta:</span>
                             <span id="my-bet-display" class="text-green-400 font-mono">$0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTROLS -->
            <div id="controls-blackjack" class="w-full max-w-md grid grid-cols-2 gap-4 p-4 hidden-screen">
                <button onclick="sendAction('hit')" id="btn-hit" class="bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-green-900 active:translate-y-1">PEDIR (+1)</button>
                <button onclick="sendAction('stand')" id="btn-stand" class="bg-red-700 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-red-900 active:translate-y-1">PLANTARSE</button>
            </div>

            <div id="controls-poker" class="w-full max-w-md p-4 hidden-screen">
                <button onclick="sendPokerExchange()" id="btn-exchange" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-blue-900 active:translate-y-1">
                    CONFIRMAR CAMBIO
                </button>
            </div>

            <div id="controls-texas" class="w-full max-w-md grid grid-cols-2 gap-4 p-4 hidden-screen">
                <button onclick="sendAction('call')" id="btn-texas-call" class="bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-green-800 active:translate-y-1 text-sm md:text-base flex flex-col items-center leading-none gap-1">
                    <span>¡VOY!</span><span class="text-[10px] opacity-80">(Igualar Apuesta)</span>
                </button>
                <button onclick="sendAction('fold')" id="btn-texas-fold" class="bg-red-700 hover:bg-red-600 text-white py-3 rounded-lg font-bold shadow-lg border-b-4 border-red-900 active:translate-y-1 text-sm md:text-base flex flex-col items-center leading-none gap-1">
                    <span>NO VOY</span><span class="text-[10px] opacity-80">(Retirarse)</span>
                </button>
            </div>

            <!-- VIUDA CONTROLS -->
            <div id="controls-viuda" class="w-full max-w-md p-4 hidden-screen space-y-2">
                <!-- Host Selection -->
                <div id="viuda-host-opts" class="hidden-screen grid grid-cols-2 gap-4">
                    <button onclick="sendAction('keep_hand')" class="bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg font-bold shadow-lg">ME QUEDO MI MANO</button>
                    <button onclick="sendAction('take_widow')" class="bg-purple-700 hover:bg-purple-600 text-white py-3 rounded-lg font-bold shadow-lg">QUIERO LA VIUDA</button>
                </div>
                <!-- Buy Offer -->
                <div id="viuda-buy-opts" class="hidden-screen grid grid-cols-2 gap-4">
                    <button onclick="sendAction('pass_widow')" class="bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-lg font-bold shadow-lg">PASAR</button>
                    <button onclick="sendAction('buy_widow')" class="bg-green-700 hover:bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg">COMPRAR ($)</button>
                </div>
                <!-- Gameplay -->
                <div id="viuda-play-opts" class="hidden-screen grid grid-cols-3 gap-2">
                     <button onclick="sendViudaSwap1()" id="btn-swap-1" class="bg-blue-600 text-white py-3 rounded-lg font-bold text-xs disabled:opacity-50">CAMBIAR 1</button>
                     <button onclick="sendAction('swap_all')" id="btn-swap-all" class="bg-purple-600 text-white py-3 rounded-lg font-bold text-xs">CAMBIAR 5</button>
                     <button onclick="sendAction('knock')" id="btn-knock" class="bg-yellow-600 text-white py-3 rounded-lg font-bold text-xs">TOCAR</button>
                </div>
            </div>
        </div>

        <!-- RESULTS MODAL -->
        <div id="modal-results" class="hidden-screen fixed inset-0 z-[100] bg-black/90 flex items-center justify-center backdrop-blur-md p-4">
            <div class="bg-slate-900 p-6 rounded-2xl border-2 border-yellow-500 text-center max-w-sm w-full shadow-[0_0_50px_rgba(234,179,8,0.3)]">
                <i class="fa-solid fa-trophy text-5xl text-yellow-400 mb-4 animate-bounce"></i>
                <h2 class="text-3xl brand-font text-white mb-2">RESULTADOS</h2>
                <div id="results-content" class="text-slate-300 text-base mb-6 space-y-2"></div>
                <button onclick="exitGameRoom()" class="bg-yellow-600 hover:bg-yellow-500 text-slate-900 font-bold py-2 px-6 rounded-lg w-full">Volver al Menú</button>
            </div>
        </div>

        <!-- CHAT SYSTEM -->
        <button onclick="toggleChat()" class="fixed bottom-4 right-4 bg-yellow-600 text-white w-14 h-14 rounded-full shadow-lg z-50 hover:bg-yellow-500 transition flex items-center justify-center border-2 border-yellow-400">
            <i class="fa-solid fa-comments text-xl"></i>
        </button>

        <div id="chat-window" class="fixed bottom-24 right-4 w-80 h-96 bg-slate-900 border-2 border-yellow-600 rounded-xl shadow-2xl z-40 flex flex-col hidden-screen backdrop-blur-md">
            <div class="bg-slate-800 p-3 rounded-t-lg border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-yellow-500 font-bold brand-font">Chat de Sala</h3>
                <button onclick="toggleChat()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="chat-messages" class="flex-grow overflow-y-auto p-3 space-y-3 text-sm text-slate-300"></div>
            <div class="p-3 border-t border-slate-700 bg-slate-800/50 rounded-b-xl">
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Enviar mensaje..." class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-white focus:border-yellow-500 outline-none" onkeypress="handleChatKey(event)">
                    <button onclick="sendChatMessage()" class="bg-yellow-600 text-white px-3 rounded hover:bg-yellow-500"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </main>

    <script>
        const socket = io('https://casino-cwf2.onrender.com');
        const SCREENS = ['screen-landing', 'screen-selection', 'screen-lobby', 'screen-game'];
        let currentState = { 
            name: "", 
            room: "", 
            isHost: false, 
            gameType: 'blackjack',
            pokerDiscards: [],
            wildRank: null,
            viudaSwap: { handIdx: null, commIdx: null }
        };
        let lastHandSizes = {}; 

        // --- NAVIGATION ---
        function showScreen(id) {
            SCREENS.forEach(s => document.getElementById(s).classList.add('hidden-screen'));
            document.getElementById(id).classList.remove('hidden-screen');
        }

        function goToSelection() {
            const name = document.getElementById('usernameInput').value.trim();
            if(!name) return alert("Por favor, ingresa un alias.");
            currentState.name = name;
            showScreen('screen-selection');
        }

        function selectGame(game) {
            currentState.gameType = game;
            let title = "Sala de Juego";
            if (game === 'poker') title = 'Sala de Póker';
            if (game === 'blackjack') title = 'Sala de Blackjack';
            if (game === 'texas') title = "Sala Texas Hold'em";
            if (game === 'viuda') title = "Sala Viuda Negra";
            
            document.getElementById('lobby-title').textContent = title;
            
            // Mostrar opción de comodines para Poker, Texas y Viuda
            if(['poker', 'texas', 'viuda'].includes(game)) {
                document.getElementById('wildcard-option').classList.remove('hidden');
            } else {
                document.getElementById('wildcard-option').classList.add('hidden');
            }
            
            showScreen('screen-lobby');
        }

        function exitGameRoom() {
            showScreen('screen-selection');
            document.getElementById('modal-results').classList.add('hidden-screen');
            document.getElementById('chat-messages').innerHTML = '';
        }

        // --- GAME LOGIC ---

        function createRoom() {
            const wildcards = document.getElementById('wildcardToggle').checked;
            const bet = document.getElementById('betInput').value;
            socket.emit('create_room', { 
                host: currentState.name, 
                game: currentState.gameType,
                wildcards: (['poker', 'texas', 'viuda'].includes(currentState.gameType) && wildcards),
                bet: bet
            });
        }

        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if(!code) return alert("Ingresa código");
            socket.emit('join_room', { player: currentState.name, room: code });
            document.getElementById('chat-messages').innerHTML = '';
        }

        function startGame() {
            socket.emit('start_game', { room: currentState.room });
            lastHandSizes = {}; 
            currentState.pokerDiscards = []; 
        }

        function sendAction(action) {
            socket.emit('player_action', { 
                room: currentState.room, 
                player: currentState.name, 
                action: action 
            });
            if(currentState.gameType === 'texas') {
                document.getElementById('btn-texas-call').disabled = true;
                document.getElementById('btn-texas-call').classList.add('opacity-50');
                document.getElementById('btn-texas-fold').disabled = true;
                document.getElementById('btn-texas-fold').classList.add('opacity-50');
            }
        }
        
        function toggleDiscard(index) {
            if(currentState.gameType !== 'poker') return;
            const cardEl = document.getElementById(`my-card-${index}`);
            if(currentState.pokerDiscards.includes(index)) {
                currentState.pokerDiscards = currentState.pokerDiscards.filter(i => i !== index);
                cardEl.classList.remove('discard-selected');
            } else {
                currentState.pokerDiscards.push(index);
                cardEl.classList.add('discard-selected');
            }
            const btn = document.getElementById('btn-exchange');
            if(currentState.pokerDiscards.length > 0) {
                btn.textContent = `CAMBIAR ${currentState.pokerDiscards.length} CARTAS`;
            } else {
                btn.textContent = "NO CAMBIAR NADA (SERVIDO)";
            }
        }

        function sendPokerExchange() {
            socket.emit('player_action', {
                room: currentState.room,
                player: currentState.name,
                action: 'exchange',
                data: { discard_indices: currentState.pokerDiscards }
            });
            document.getElementById('btn-exchange').disabled = true;
            document.getElementById('btn-exchange').textContent = "ESPERANDO RIVALES...";
            document.getElementById('poker-instructions').classList.add('hidden-screen');
        }

        // --- VIUDA LOGIC ---
        function selectSwapCard(idx, type) {
            if (currentState.gameType !== 'viuda') return;
            
            // UI Toggle
            if (type === 'hand') {
                // Clear previous hand selection
                for(let i=0; i<5; i++) {
                     const el = document.getElementById(`my-card-${i}`);
                     if(el) el.classList.remove('swap-hand-selected');
                }
                currentState.viudaSwap.handIdx = idx;
                document.getElementById(`my-card-${idx}`).classList.add('swap-hand-selected');
            } else if (type === 'comm') {
                // Clear previous comm selection
                for(let i=0; i<5; i++) {
                     const el = document.getElementById(`comm-card-${i}`);
                     if(el) el.classList.remove('swap-comm-selected');
                }
                currentState.viudaSwap.commIdx = idx;
                document.getElementById(`comm-card-${idx}`).classList.add('swap-comm-selected');
            }
        }

        function sendViudaSwap1() {
             if (currentState.viudaSwap.handIdx === null || currentState.viudaSwap.commIdx === null) {
                 return alert("Selecciona una carta de tu mano y una del centro");
             }
             socket.emit('player_action', {
                room: currentState.room,
                player: currentState.name,
                action: 'swap_1',
                data: { hand_idx: currentState.viudaSwap.handIdx, comm_idx: currentState.viudaSwap.commIdx }
            });
            currentState.viudaSwap = { handIdx: null, commIdx: null };
        }

        // --- CHAT LOGIC ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('hidden-screen');
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;
            socket.emit('send_message', { room: currentState.room, player: currentState.name, message: msg });
            input.value = "";
        }

        function handleChatKey(e) {
            if(e.key === 'Enter') sendChatMessage();
        }

        // --- SOCKET LISTENERS ---

        socket.on('chat_message', (data) => {
            const chat = document.getElementById('chat-messages');
            const isMe = data.player === currentState.name;
            const msgHtml = `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-deal">
                    <span class="text-[10px] ${isMe ? 'text-yellow-600' : 'text-slate-500'} font-bold mb-0.5">${data.player}</span>
                    <div class="${isMe ? 'bg-yellow-900/30 border-yellow-600/50 text-yellow-100' : 'bg-slate-800 border-slate-600 text-slate-200'} border px-3 py-1.5 rounded-lg max-w-[90%] break-words shadow-sm text-xs">
                        ${data.message}
                    </div>
                </div>
            `;
            chat.insertAdjacentHTML('beforeend', msgHtml);
            chat.scrollTop = chat.scrollHeight; 
        });

        socket.on('room_created', (data) => {
            currentState.room = data.room_id;
            currentState.isHost = true;
            currentState.gameType = data.game_type;
            setupLobbyUI();
        });

        socket.on('joined_room', (data) => {
            currentState.room = data.room_id;
            currentState.isHost = false;
            currentState.gameType = data.game_type;
            setupLobbyUI();
        });

        socket.on('update_players', (data) => {
            const list = document.getElementById('players-list');
            list.innerHTML = "";
            data.players.forEach(p => {
                list.innerHTML += `<li class="flex justify-between text-slate-300">
                    <span>${p}</span> 
                    ${p === data.host ? '<i class="fa-solid fa-crown text-yellow-500"></i>' : ''}
                </li>`;
            });

            if(currentState.name === data.host) {
                document.getElementById('btn-start').classList.remove('hidden-screen');
                document.getElementById('msg-waiting-host').classList.add('hidden-screen');
            } else {
                document.getElementById('btn-start').classList.add('hidden-screen');
                document.getElementById('msg-waiting-host').classList.remove('hidden-screen');
            }
        });

        socket.on('game_started', (state) => {
            lastHandSizes = {}; 
            currentState.pokerDiscards = [];
            currentState.wildRank = state.wild_rank;
            currentState.viudaSwap = { handIdx: null, commIdx: null };
            showScreen('screen-game');
            setupGameUI(state); 
            updateTable(state);
        });

        socket.on('update_game_state', updateTable);
        
        socket.on('game_over', (state) => {
            updateTable(state);
            setTimeout(() => showResults(state), 1500);
        });

        // --- UI HELPERS ---

        function setupLobbyUI() {
            document.getElementById('lobby-controls').classList.add('hidden-screen');
            document.getElementById('lobby-waiting').classList.remove('hidden-screen');
            document.getElementById('display-code').textContent = currentState.room;
            document.getElementById('game-mode-display').textContent = currentState.gameType.toUpperCase();
        }

        function setupGameUI(state) {
            document.getElementById('pot-display').textContent = "$" + state.pot;
            document.getElementById('my-bet-display').textContent = "$" + state.bet;

            const badge = document.getElementById('wildcard-badge');
            if(state.wild_rank) {
                badge.classList.remove('hidden', 'opacity-0');
                document.getElementById('wild-card-display').textContent = state.wild_rank;
            } else {
                badge.classList.add('hidden', 'opacity-0');
            }

            // Hide all controls
            document.getElementById('controls-blackjack').classList.add('hidden-screen');
            document.getElementById('controls-poker').classList.add('hidden-screen');
            document.getElementById('controls-texas').classList.add('hidden-screen');
            document.getElementById('controls-viuda').classList.add('hidden-screen');
            document.getElementById('poker-instructions').classList.add('hidden-screen');
            document.getElementById('my-score-container').classList.add('hidden-screen'); 
            
            document.getElementById('viuda-host-opts').classList.add('hidden-screen');
            document.getElementById('viuda-buy-opts').classList.add('hidden-screen');
            document.getElementById('viuda-play-opts').classList.add('hidden-screen');

            if(state.game_type === 'blackjack') {
                document.getElementById('controls-blackjack').classList.remove('hidden-screen');
                document.getElementById('my-score-container').classList.remove('hidden-screen'); 
            } else if (state.game_type === 'poker') {
                document.getElementById('controls-poker').classList.remove('hidden-screen');
                document.getElementById('btn-exchange').disabled = false;
                document.getElementById('btn-exchange').textContent = "NO CAMBIAR NADA (SERVIDO)";
                document.getElementById('poker-instructions').classList.remove('hidden-screen');
            } else if (state.game_type === 'texas') {
                document.getElementById('controls-texas').classList.remove('hidden-screen');
            } else if (state.game_type === 'viuda') {
                document.getElementById('controls-viuda').classList.remove('hidden-screen');
            }
        }

        function renderCard(card, idx, isHidden=false, isClickable=false, onClickFn='') {
            if(isHidden) {
                return `<div class="card hidden-card" style="margin-left: -30px;"></div>`;
            }
            const color = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
            const isWild = (currentState.wildRank && card.rank === currentState.wildRank);
            
            const onclickAttr = onClickFn ? `onclick="${onClickFn}"` : (isClickable ? `onclick="toggleDiscard(${idx})"` : '');
            
            return `
                <div id="${onClickFn ? (onClickFn.includes('comm') ? 'comm-card-'+idx : 'my-card-'+idx) : (isClickable ? 'my-card-'+idx : '')}" 
                     class="card ${color} ${isWild ? 'wild' : ''} ${isClickable || onClickFn ? 'cursor-pointer hover:mt-[-10px]' : ''}" 
                     style="margin-left: -30px;" 
                     ${onclickAttr}>
                    <div class="absolute top-1 left-1 text-xs">${card.rank}</div>
                    <div class="text-xl">${card.suit}</div>
                    <div class="absolute bottom-1 right-1 text-xs transform rotate-180">${card.rank}</div>
                    ${isWild ? '<div class="absolute inset-0 flex items-center justify-center text-purple-500 opacity-20 text-4xl font-bold">★</div>' : ''}
                </div>
            `;
        }
        
        function renderCommunityCard(card, idx, isViuda=false) {
             const color = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
             const clickFn = isViuda ? `onclick="selectSwapCard(${idx}, 'comm')"` : '';
             const cursor = isViuda ? 'cursor-pointer hover:mb-2' : '';
             const idAttr = isViuda ? `id="comm-card-${idx}"` : '';
             const isWild = (currentState.wildRank && card.rank === currentState.wildRank);

             return `
                <div ${idAttr} class="card ${color} ${isWild ? 'wild' : ''} animate-deal ${cursor}" style="margin: 0; animation-delay: ${idx * 0.1}s" ${clickFn}>
                    <div class="absolute top-1 left-1 text-xs">${card.rank}</div>
                    <div class="text-xl">${card.suit}</div>
                    <div class="absolute bottom-1 right-1 text-xs transform rotate-180">${card.rank}</div>
                     ${isWild ? '<div class="absolute inset-0 flex items-center justify-center text-purple-500 opacity-20 text-4xl font-bold">★</div>' : ''}
                </div>
             `;
        }

        function updateTable(state) {
            const bar = document.getElementById('game-status-bar');
            document.getElementById('pot-display').textContent = "$" + state.pot;

            // --- STATUS BAR ---
            let statusText = "";
            let statusClass = "bg-black/60 px-6 py-2 rounded-full text-white font-bold mb-2";

            if (state.game_type === 'viuda') {
                 // VIUDA STATES
                 if (state.status === 'selection_host') {
                     if (currentState.isHost) {
                         statusText = "DECISIÓN: ¿MANO O VIUDA?";
                         statusClass = "bg-green-600 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                         document.getElementById('viuda-host-opts').classList.remove('hidden-screen');
                     } else {
                         statusText = "EL ANFITRION ESTÁ ELIGIENDO...";
                         document.getElementById('viuda-host-opts').classList.add('hidden-screen');
                     }
                     document.getElementById('viuda-buy-opts').classList.add('hidden-screen');
                     document.getElementById('viuda-play-opts').classList.add('hidden-screen');
                 } else if (state.status === 'offering_widow') {
                     if (state.offer_target === currentState.name) {
                         statusText = "¿COMPRAR VIUDA?";
                         statusClass = "bg-green-600 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                         document.getElementById('viuda-buy-opts').classList.remove('hidden-screen');
                     } else {
                         statusText = `OFRECIENDO VIUDA A ${state.offer_target}`;
                         document.getElementById('viuda-buy-opts').classList.add('hidden-screen');
                     }
                     document.getElementById('viuda-host-opts').classList.add('hidden-screen');
                     document.getElementById('viuda-play-opts').classList.add('hidden-screen');
                 } else if (state.status === 'playing' || state.status === 'last_round') {
                     document.getElementById('viuda-host-opts').classList.add('hidden-screen');
                     document.getElementById('viuda-buy-opts').classList.add('hidden-screen');
                     
                     if (state.status === 'last_round') statusText = "¡ÚLTIMA RONDA!";
                     else statusText = "JUEGO EN CURSO";
                     
                     if (state.turn === currentState.name) {
                         statusText = (state.status === 'last_round') ? "¡TU ÚLTIMO TURNO!" : "TU TURNO";
                         statusClass = "bg-green-600 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                         document.getElementById('viuda-play-opts').classList.remove('hidden-screen');
                         
                         // Disable Knock if last round
                         if (state.status === 'last_round') document.getElementById('btn-knock').classList.add('hidden-screen');
                         else document.getElementById('btn-knock').classList.remove('hidden-screen');
                     } else {
                         statusText = `TURNO DE: ${state.turn}`;
                         document.getElementById('viuda-play-opts').classList.add('hidden-screen');
                     }
                 }
                 
                 // Render Community/Viuda Cards
                 const commContainer = document.getElementById('community-cards-container');
                 let commHtml = "";
                 
                 if (state.status === 'selection_host') {
                     // Show Widow face down
                     for(let i=0; i<5; i++) commHtml += `<div class="card hidden-card" style="margin:2px"></div>`;
                 } else if (state.status === 'offering_widow') {
                     // Still face down
                     for(let i=0; i<5; i++) commHtml += `<div class="card hidden-card" style="margin:2px"></div>`;
                 } else {
                     // Community Cards open
                     if (state.community_pile) {
                        state.community_pile.forEach((c, i) => {
                            // Enable click if my turn
                            const canClick = (state.turn === currentState.name);
                            commHtml += renderCommunityCard(c, i, canClick);
                        });
                     }
                 }
                 commContainer.innerHTML = commHtml;
                 
            } else if(state.game_type === 'blackjack') {
                if(state.turn === currentState.name) {
                    statusText = "¡TU TURNO!";
                    statusClass = "bg-green-600 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                    document.getElementById('btn-hit').disabled = false;
                    document.getElementById('btn-stand').disabled = false;
                } else {
                    statusText = `Turno de: ${state.turn || 'Nadie'}`;
                    document.getElementById('btn-hit').disabled = true;
                    document.getElementById('btn-stand').disabled = true;
                }
            } else if (state.game_type === 'poker') {
                if(state.status === 'discard_phase') {
                    if(state.ready_players && state.ready_players.includes(currentState.name)) {
                        statusText = "ESPERANDO A LOS DEMÁS...";
                        statusClass = "bg-blue-900 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                    } else {
                        statusText = "ELIGE CARTAS PARA CAMBIAR";
                        statusClass = "bg-green-600 px-6 py-2 rounded-full text-white font-bold mb-2";
                    }
                } else {
                    statusText = "PARTIDA TERMINADA";
                    statusClass = "bg-yellow-600 px-6 py-2 rounded-full text-black font-bold mb-2";
                }
            } else if (state.game_type === 'texas') {
                const myDecided = state.decided_players.includes(currentState.name);
                const amIActive = state.active_players.includes(currentState.name);
                
                if (state.status === 'finished') {
                    statusText = "PARTIDA TERMINADA";
                    statusClass = "bg-yellow-600 px-6 py-2 rounded-full text-black font-bold mb-2";
                } else if (!amIActive) {
                    statusText = "TE HAS RETIRADO";
                    statusClass = "bg-red-900/50 px-6 py-2 rounded-full text-red-200 font-bold mb-2";
                    document.getElementById('btn-texas-call').disabled = true;
                    document.getElementById('btn-texas-fold').disabled = true;
                    document.getElementById('controls-texas').classList.add('opacity-50');
                } else if (myDecided) {
                    statusText = "ESPERANDO RIVALES...";
                    statusClass = "bg-blue-900 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                    document.getElementById('btn-texas-call').disabled = true;
                    document.getElementById('btn-texas-fold').disabled = true;
                    document.getElementById('btn-texas-call').classList.add('opacity-50');
                    document.getElementById('btn-texas-fold').classList.add('opacity-50');
                } else {
                    statusText = "¿VAS O NO VAS?";
                    statusClass = "bg-green-600 px-6 py-2 rounded-full text-white font-bold mb-2 animate-pulse";
                    document.getElementById('btn-texas-call').disabled = false;
                    document.getElementById('btn-texas-fold').disabled = false;
                    document.getElementById('btn-texas-call').classList.remove('opacity-50');
                    document.getElementById('btn-texas-fold').classList.remove('opacity-50');
                }
                
                // Render Community Cards Texas
                const commContainer = document.getElementById('community-cards-container');
                let commHtml = "";
                if (state.community_cards) {
                    state.community_cards.forEach((c, i) => {
                        commHtml += renderCommunityCard(c, i);
                    });
                }
                commContainer.innerHTML = commHtml;
            }

            bar.textContent = statusText;
            bar.className = statusClass;

            // MY HAND
            const myCards = state.hands[currentState.name] || [];
            let myHandHtml = "";
            myCards.forEach((c, i) => {
                let clickable = false;
                let clickFn = '';
                if (state.game_type === 'poker' && state.status === 'discard_phase' && !state.ready_players.includes(currentState.name)) {
                    clickable = true;
                }
                if (state.game_type === 'viuda' && (state.status === 'playing' || state.status === 'last_round') && state.turn === currentState.name) {
                    clickable = true;
                    clickFn = `selectSwapCard(${i}, 'hand')`;
                }
                myHandHtml += renderCard(c, i, false, clickable, clickFn);
            });
            document.getElementById('my-hand').innerHTML = myHandHtml;

            if(state.game_type === 'blackjack') {
                document.getElementById('my-score-bubble').textContent = state.scores[currentState.name];
            }

            // OPPONENTS
            const oppArea = document.getElementById('opponents-area');
            oppArea.innerHTML = "";
            const allPlayers = Object.keys(state.hands);
            
            allPlayers.forEach(p => {
                if(p === currentState.name) return;
                
                const oppCards = state.hands[p] || [];
                let cardsHtml = "";
                
                let showAll = (state.status === 'finished');
                
                if (state.game_type === 'texas') {
                    const isActive = state.active_players && state.active_players.includes(p);
                    if (!isActive && state.status !== 'finished') {
                        cardsHtml = `<div class="text-xs text-red-400 font-bold mt-4">SE RETIRÓ</div>`;
                    } else {
                        if (showAll) oppCards.forEach((c, i) => cardsHtml += renderCard(c, i));
                        else oppCards.forEach((c, i) => cardsHtml += renderCard(null, i, true));
                    }
                } else {
                     if (showAll) oppCards.forEach((c, i) => cardsHtml += renderCard(c, i));
                     else {
                         if(state.game_type === 'blackjack' && oppCards.length > 0) {
                              cardsHtml += renderCard(oppCards[0], 0); 
                              for(let i=1; i<oppCards.length; i++) cardsHtml += renderCard(null, i, true);
                         } else {
                              oppCards.forEach((c, i) => cardsHtml += renderCard(null, i, true));
                         }
                     }
                }

                let subtitle = "";
                if(state.status === 'finished') {
                     if(['poker', 'texas', 'viuda'].includes(state.game_type)) {
                        let shortName = state.hand_names[p] || '';
                        if (!shortName && state.game_type === 'texas' && !state.active_players.includes(p)) shortName = "Retirado";
                        if(shortName.length > 15) shortName = shortName.substring(0, 15) + "...";
                        subtitle = `<span class="text-[10px] text-yellow-400 font-bold block leading-tight">${shortName}</span>`;
                    } else {
                        subtitle = `<span class="text-xs font-mono bg-black/50 px-2 rounded text-yellow-500">${state.scores[p]}</span>`;
                    }
                } else {
                     if (state.game_type === 'texas') {
                         if (state.decided_players.includes(p)) {
                              const decision = (state.active_players.includes(p)) ? "VOY" : "NO VOY";
                              const color = (decision === "VOY") ? "text-green-400" : "text-red-400";
                              subtitle = `<span class="text-[10px] ${color} font-bold">${decision}</span>`;
                         } else subtitle = `<span class="text-[10px] text-slate-500 italic">Pensando...</span>`;
                     } else if (state.game_type === 'viuda') {
                         if (state.knocker === p) subtitle = `<span class="text-xs text-red-500 font-bold animate-pulse">¡TOCÓ!</span>`;
                         else subtitle = `<span class="text-[10px] text-slate-500 italic">Jugando...</span>`;
                     } else {
                         subtitle = `<span class="text-[10px] text-slate-500 italic">Pensando...</span>`;
                     }
                }

                if (cardsHtml !== "") {
                    oppArea.innerHTML += `
                        <div class="flex flex-col items-center bg-slate-900/80 p-2 rounded-lg border border-slate-700 relative">
                            <div class="flex pl-6 mb-1 transform scale-75 origin-top relative z-10">${cardsHtml}</div>
                            <div class="flex flex-col items-center justify-center w-full px-1 mt-1">
                                <span class="text-xs text-slate-300 font-bold truncate max-w-[80px]">${p}</span>
                                ${subtitle}
                            </div>
                        </div>
                    `;
                }
            });
        }

        function showResults(state) {
            const el = document.getElementById('modal-results');
            const content = document.getElementById('results-content');
            el.classList.remove('hidden-screen');
            
            let html = "";
            if(state.winners.includes(currentState.name)) {
                html += `
                    <p class="text-green-400 font-bold text-2xl mb-2">¡GANASTE!</p>
                    <p class="text-yellow-500 text-lg mb-2">Te llevas el pozo: $${state.pot}</p>
                `;
            } else if (state.winners.length > 0) {
                html += `<p class="text-white mb-2">Ganador: <span class="text-yellow-400 font-bold">${state.winners.join(', ')}</span></p>`;
            } else {
                html += `<p class="text-red-400 font-bold text-xl">NADIE GANA</p>`;
            }

            html += `<p class="text-sm text-slate-400 italic">${state.win_reason}</p>`;
            
            if(['poker', 'texas', 'viuda'].includes(state.game_type) && state.hand_names) {
                const myHandName = state.hand_names[currentState.name] || (state.game_type==='texas' && state.active_players && !state.active_players.includes(currentState.name) ? "Te Retiraste" : "");
                if (myHandName) {
                    html += `<div class="mt-4 bg-slate-800 p-3 rounded text-sm text-slate-300 border border-slate-600">
                        <p class="text-xs text-slate-500 uppercase font-bold mb-1">Tu Jugada</p>
                        <span class="text-white font-bold text-lg">${myHandName}</span>
                    </div>`;
                }
            }
            content.innerHTML = html;
        }
    </script>
</body>
</html>
