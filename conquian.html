<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conqui치n Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .card { aspect-ratio: 2/3; transition: transform 0.2s; user-select: none; }
        .card:hover { transform: translateY(-10px); z-index: 20; }
        .felt-bg {
            background-color: #0f4d19;
            background-image: radial-gradient(#166534 15%, transparent 16%), radial-gradient(#166534 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
        }
        .glow-card { box-shadow: 0 0 20px 5px rgba(251, 191, 36, 0.8); transform: scale(1.1); }
        .selected-card { border: 4px solid #facc15; transform: translateY(-15px); }
        
        /* Zona de juegos bajados (peque침os) */
        .meld-card { width: 40px; height: 60px; }
    </style>
</head>
<body class="felt-bg h-screen text-gray-100 font-sans overflow-hidden">

    <!-- LOGIN -->
    <div id="loginScreen" class="flex flex-col items-center justify-center h-full bg-black/60 fixed inset-0 z-50">
        <div class="bg-white text-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full border-4 border-yellow-600">
            <h1 class="text-4xl font-bold text-center mb-6 text-yellow-700">Conqui치n MX</h1>
            <input type="text" id="aliasInput" class="w-full p-3 border rounded mb-4 bg-gray-50" placeholder="Tu Apodo">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="createRoom()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded">Crear Sala</button>
                <button onclick="document.getElementById('joinSection').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded">Unirse</button>
            </div>
            <div id="joinSection" class="hidden mt-4">
                <input type="text" id="roomCodeInput" oninput="this.value = this.value.toUpperCase()" class="w-full p-2 border rounded mb-2 uppercase font-mono text-center tracking-widest text-xl" placeholder="C칍DIGO" maxlength="4">
                <button id="btnJoin" onclick="joinRoom()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">Entrar</button>
            </div>
            <p id="errorMsg" class="text-red-500 text-center mt-2 font-bold min-h-[24px]"></p>
        </div>
    </div>

    <!-- LOBBY -->
    <div id="lobbyScreen" class="hidden flex flex-col items-center justify-center h-full bg-black/80 fixed inset-0 z-40">
        <div class="bg-gray-800 p-8 rounded-xl max-w-lg w-full text-center border border-yellow-500">
            <h2 class="text-3xl text-yellow-400 mb-2">Sala: <span id="lobbyCode" class="text-white font-mono bg-gray-700 px-2 rounded"></span></h2>
            <p class="text-gray-400 mb-6">Esperando jugadores...</p>
            <ul id="lobbyList" class="text-left space-y-2 mb-6 bg-gray-900 p-4 rounded min-h-[100px]"></ul>
            <div id="hostControls" class="hidden">
                <button onclick="startGame()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg text-lg animate-pulse">INICIAR PARTIDA</button>
            </div>
            <p id="waitMsg" class="text-yellow-200/50 mt-4 text-sm italic">Solo el anfitri칩n puede iniciar.</p>
        </div>
    </div>

    <!-- JUEGO -->
    <div id="gameScreen" class="hidden h-full flex flex-col relative">
        <div class="bg-black/40 p-2 flex justify-between items-center px-4 z-10">
            <div class="font-bold text-yellow-400 text-sm">Sala: <span id="gameRoomCode"></span></div>
            <div id="gameStatus" class="bg-gray-700 px-4 py-1 rounded-full text-xs md:text-sm font-bold truncate max-w-[200px]">Iniciando...</div>
        </div>

        <div class="flex-1 flex flex-col relative p-2">
            <!-- Zona de Juegos Bajados (Melds) -->
            <div id="meldsArea" class="h-1/4 border-b border-white/10 flex flex-wrap gap-4 p-2 overflow-y-auto justify-center">
                <!-- Aqu칤 van los juegos de todos -->
            </div>

            <!-- Centro: Mazo y Carta Mesa -->
            <div class="h-1/3 flex justify-center items-center gap-8 md:gap-16 relative mt-4">
                <!-- Mazo -->
                <div class="relative">
                    <div class="w-24 h-36 bg-blue-900 border-2 border-white rounded-lg shadow-xl flex items-center justify-center bg-[url('cards/reverso.png')] bg-cover bg-center">
                        <span id="deckCount" class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow">40</span>
                    </div>
                </div>

                <!-- Carta Activa (Mesa) -->
                <div class="relative">
                    <div id="tableCard" class="w-24 h-36 border-2 border-dashed border-white/30 rounded-lg flex items-center justify-center transition-all duration-300">
                        <span class="text-white/30 text-xs">Mesa</span>
                    </div>
                    
                    <!-- Botones Oferta -->
                    <div id="offerButtons" class="hidden absolute -bottom-14 left-1/2 transform -translate-x-1/2 flex gap-2 w-max z-30">
                        <button onclick="respondOffer('take')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded shadow font-bold text-xs uppercase">Me Sirve</button>
                        <button onclick="respondOffer('pass')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded shadow font-bold text-xs uppercase">Pasar</button>
                    </div>

                    <!-- Bot칩n Confirmar Bajada -->
                    <div id="meldConfirmBtn" class="hidden absolute -bottom-14 left-1/2 transform -translate-x-1/2 w-max z-30">
                        <button onclick="submitMeld()" class="bg-yellow-600 hover:bg-yellow-500 text-black px-4 py-2 rounded shadow font-bold text-xs uppercase animate-pulse">BAJAR JUEGO</button>
                    </div>
                </div>
            </div>

            <!-- Mano del Jugador -->
            <div id="handContainer" class="flex-1 flex flex-col justify-end pb-2 relative z-0">
                <p id="handInstruction" class="text-center text-xs text-yellow-200/70 mb-1">Tu Mano</p>
                <div id="myHand" class="flex justify-center -space-x-4 overflow-visible px-4 min-h-[120px]"></div>
            </div>
        </div>
        
        <!-- Mensajes Sistema -->
        <div id="systemMsg" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-black/80 text-yellow-200 px-6 py-2 rounded-full text-sm shadow-xl backdrop-blur hidden z-50 text-center w-max max-w-[90%]"></div>

        <!-- Overlay Intercambio -->
        <div id="exchangeOverlay" class="hidden absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center p-4">
            <h2 class="text-2xl text-yellow-400 font-bold mb-4">Intercambio</h2>
            <p id="exchangeText" class="text-white mb-8 text-center">Pasa una carta a la derecha.</p>
            <div id="exchangeArrow" class="animate-bounce text-yellow-500 text-2xl"><i class="fas fa-arrow-down"></i></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://conquian.onrender.com';
        const socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });

        let myState = {
            alias: '', roomCode: '', isHost: false, hand: [], phase: 'LOBBY', 
            selectedCards: [] // IDs de cartas seleccionadas para bajar
        };

        const els = {
            login: document.getElementById('loginScreen'),
            lobby: document.getElementById('lobbyScreen'),
            game: document.getElementById('gameScreen'),
            hand: document.getElementById('myHand'),
            table: document.getElementById('tableCard'),
            status: document.getElementById('gameStatus'),
            offerBtns: document.getElementById('offerButtons'),
            meldBtn: document.getElementById('meldConfirmBtn'),
            meldsArea: document.getElementById('meldsArea'),
            sysMsg: document.getElementById('systemMsg'),
            exchangeOverlay: document.getElementById('exchangeOverlay'),
            exchangeText: document.getElementById('exchangeText')
        };

        // --- SOCKET ---
        socket.on('room_created', d => { myState.roomCode=d.roomCode; myState.alias=d.alias; myState.isHost=d.isHost; renderLobby(d.players); showLobby(); });
        socket.on('player_joined', d => { if(d.alias===myState.alias) { myState.roomCode=d.roomCode; showLobby(); } renderLobby(d.players); });
        socket.on('lobby_update', d => renderLobby(d.players));
        
        socket.on('game_start_exchange', d => {
            myState.hand = d.hand; myState.phase = 'EXCHANGE';
            showGame(); els.exchangeOverlay.classList.remove('hidden'); renderHand();
        });
        socket.on('exchange_wait', d => { els.exchangeText.innerHTML = "Esperando..."; });
        socket.on('exchange_complete', d => {
            myState.hand = d.newHand; els.exchangeOverlay.classList.add('hidden');
            showSysMsg(`Recibiste: ${d.receivedCard.rank} ${d.receivedCard.suit}`); renderHand();
        });

        socket.on('game_state_update', d => updateGameState(d));
        socket.on('hand_update', d => { myState.hand = d.hand; renderHand(); });
        socket.on('system_msg', d => showSysMsg(d.msg));
        socket.on('error', d => { document.getElementById('errorMsg').innerText = d.msg; });

        // --- GAME LOGIC ---
        function updateGameState(data) {
            myState.phase = data.phase;
            const amIActive = (data.activePlayerId === socket.id);
            document.getElementById('deckCount').innerText = data.deckCount;
            
            // Render Mesa (Carta Activa)
            els.table.innerHTML = '';
            if (data.currentCard) {
                const c = createCardEl(data.currentCard, false);
                if (data.phase === 'OFFER') c.classList.add('glow-card');
                els.table.appendChild(c);
            } else {
                els.table.innerHTML = '<span class="text-white/30 text-xs">Vac칤o</span>';
            }

            // Render Melds (Juegos bajados)
            renderMelds(data.allMelds);

            // Controles
            els.offerBtns.classList.add('hidden');
            els.meldBtn.classList.add('hidden');
            document.getElementById('handInstruction').innerText = "Tu Mano";

            const activeName = amIActive ? "TI" : (data.activePlayerAlias || "Oponente");
            
            if (data.phase === 'OFFER') {
                els.status.innerText = amIActive ? `游댮 쯊E SIRVE?` : `Ofertando a ${activeName}...`;
                els.status.className = amIActive ? "bg-red-600 px-4 py-1 rounded-full text-xs font-bold animate-pulse" : "bg-gray-700 px-4 py-1 rounded-full text-xs";
                if(amIActive) els.offerBtns.classList.remove('hidden');
            
            } else if (data.phase === 'MELDING') {
                els.status.innerText = amIActive ? `游리 BAJA TU JUEGO` : `${activeName} est치 bajando...`;
                if(amIActive) {
                    els.meldBtn.classList.remove('hidden');
                    document.getElementById('handInstruction').innerText = "Selecciona cartas para combinar";
                }

            } else if (data.phase === 'DISCARDING') {
                els.status.innerText = amIActive ? `游릭 DESCARTA UNA` : `${activeName} descarta...`;
                if(amIActive) document.getElementById('handInstruction').innerText = "Toca carta para descartar";
            }
        }

        function handleCardClick(cardId, element) {
            if (myState.phase === 'EXCHANGE') {
                if(confirm("쯇asar esta carta?")) socket.emit('submit_exchange_card', {roomCode: myState.roomCode, cardId});
            } 
            else if (myState.phase === 'MELDING') {
                // Selecci칩n m칰ltiple para bajar
                if (myState.selectedCards.includes(cardId)) {
                    myState.selectedCards = myState.selectedCards.filter(id => id !== cardId);
                    element.classList.remove('selected-card');
                } else {
                    myState.selectedCards.push(cardId);
                    element.classList.add('selected-card');
                }
            }
            else if (myState.phase === 'DISCARDING') {
                socket.emit('discard_card', {roomCode: myState.roomCode, cardId});
            }
        }

        function respondOffer(action) {
            socket.emit('offer_response', {roomCode: myState.roomCode, action});
            els.offerBtns.classList.add('hidden');
            if(action === 'take') myState.selectedCards = []; // Reset selecci칩n
        }

        function submitMeld() {
            if(myState.selectedCards.length === 0) { alert("Selecciona al menos una carta de tu mano."); return; }
            socket.emit('submit_meld', {roomCode: myState.roomCode, cardIds: myState.selectedCards});
            myState.selectedCards = [];
        }

        // --- RENDER ---
        function renderLobby(players) {
            if(!players) return;
            document.getElementById('lobbyList').innerHTML = players.map(p => 
                `<li class="flex justify-between border-b border-gray-700 py-1 text-sm">
                    <span>${p.alias} ${p.alias===myState.alias?'(T칰)':''}</span>
                    ${p.isHost?'<span class="text-[10px] bg-yellow-600 px-1 rounded">HOST</span>':''}
                </li>`).join('');
            if(players.find(p => p.alias===myState.alias)?.isHost) document.getElementById('hostControls').classList.remove('hidden');
        }

        function renderHand() {
            els.hand.innerHTML = '';
            myState.hand.forEach(card => {
                const el = createCardEl(card, true);
                if(myState.phase === 'EXCHANGE') el.classList.add('exchange-highlight');
                if(myState.phase === 'MELDING' || myState.phase === 'DISCARDING') el.style.cursor = 'pointer';
                el.onclick = () => handleCardClick(card.id, el);
                els.hand.appendChild(el);
            });
        }

        function renderMelds(allMelds) {
            els.meldsArea.innerHTML = '';
            if(!allMelds) return;
            for (const [pid, melds] of Object.entries(allMelds)) {
                if(!melds || melds.length === 0) continue;
                // Crear contenedor para este jugador
                const div = document.createElement('div');
                div.className = "bg-black/30 p-2 rounded flex gap-2 items-center";
                melds.forEach(meld => {
                    const group = document.createElement('div');
                    group.className = "flex -space-x-4 bg-white/5 p-1 rounded";
                    meld.forEach(card => {
                        const c = createCardEl(card, false);
                        c.className = "card w-10 h-14 bg-white rounded shadow border border-gray-300 flex items-center justify-center"; // Override tama침o
                        c.innerHTML = `<img src="cards/${pad(card.rank)}-${card.suit.toLowerCase()}.png" class="w-full h-full object-contain">`;
                        group.appendChild(c);
                    });
                    div.appendChild(group);
                });
                els.meldsArea.appendChild(div);
            }
        }

        function createCardEl(card, interactive) {
            const el = document.createElement('div');
            const src = `cards/${pad(card.rank)}-${card.suit.toLowerCase()}.png`;
            el.className = `card w-20 h-32 rounded-lg shadow-md bg-white relative flex items-center justify-center ${interactive?'hover:border-yellow-400 border-2 border-transparent':''}`;
            el.innerHTML = `<img src="${src}" class="w-full h-full object-contain rounded-lg" onerror="this.parentElement.style.backgroundColor='red'">`;
            return el;
        }

        // Helpers
        function pad(n) { return n<10?'0'+n:n; }
        function createRoom() { socket.emit('create_room', {alias: document.getElementById('aliasInput').value}); }
        function joinRoom() { socket.emit('join_room', {alias: document.getElementById('aliasInput').value, roomCode: document.getElementById('roomCodeInput').value}); }
        function startGame() { socket.emit('start_game_request', {roomCode: myState.roomCode}); }
        function showLobby() { els.login.classList.add('hidden'); els.lobby.classList.remove('hidden'); document.getElementById('lobbyCode').innerText = myState.roomCode; }
        function showGame() { els.lobby.classList.add('hidden'); els.game.classList.remove('hidden'); document.getElementById('gameRoomCode').innerText = myState.roomCode; }
        function showSysMsg(txt) { els.sysMsg.innerText = txt; els.sysMsg.classList.remove('hidden'); setTimeout(()=>els.sysMsg.classList.add('hidden'),3000); }
    </script>
</body>
</html>
