<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conqui치n Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .card { aspect-ratio: 2/3; transition: transform 0.2s; user-select: none; }
        .card:hover { transform: translateY(-10px); z-index: 20; }
        .felt-bg {
            background-color: #0f4d19;
            background-image: radial-gradient(#166534 15%, transparent 16%), radial-gradient(#166534 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
        }
        .glow-card { box-shadow: 0 0 20px 5px rgba(251, 191, 36, 0.8); transform: scale(1.1); }
        
        /* Animaci칩n para indicar que las cartas son clickeables en el intercambio */
        .exchange-highlight { animation: pulse-border 2s infinite; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
    </style>
</head>
<body class="felt-bg h-screen text-gray-100 font-sans overflow-hidden">

    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="flex flex-col items-center justify-center h-full bg-black/60 fixed inset-0 z-50">
        <div class="bg-white text-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full border-4 border-yellow-600">
            <h1 class="text-4xl font-bold text-center mb-6 text-yellow-700">Conqui치n MX</h1>
            <input type="text" id="aliasInput" class="w-full p-3 border rounded mb-4 bg-gray-50" placeholder="Tu Apodo">
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="createRoom()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded">Crear Sala</button>
                <button onclick="document.getElementById('joinSection').classList.remove('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded">Unirse</button>
            </div>

            <div id="joinSection" class="hidden mt-4">
                <input type="text" id="roomCodeInput" oninput="this.value = this.value.toUpperCase()" class="w-full p-2 border rounded mb-2 uppercase font-mono text-center tracking-widest text-xl" placeholder="C칍DIGO SALA" maxlength="4">
                <button id="btnJoin" onclick="joinRoom()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded">Entrar</button>
            </div>
            
            <p id="errorMsg" class="text-red-500 text-center mt-2 font-bold min-h-[24px]"></p>
        </div>
    </div>

    <!-- PANTALLA DE LOBBY (ESPERA) -->
    <div id="lobbyScreen" class="hidden flex flex-col items-center justify-center h-full bg-black/80 fixed inset-0 z-40">
        <div class="bg-gray-800 p-8 rounded-xl max-w-lg w-full text-center border border-yellow-500">
            <h2 class="text-3xl text-yellow-400 mb-2">Sala: <span id="lobbyCode" class="text-white font-mono bg-gray-700 px-2 rounded"></span></h2>
            <p class="text-gray-400 mb-6">Esperando jugadores (M치x 4)...</p>
            
            <ul id="lobbyList" class="text-left space-y-2 mb-6 bg-gray-900 p-4 rounded min-h-[100px]">
                <!-- Lista de jugadores se renderiza aqu칤 -->
            </ul>

            <div id="hostControls" class="hidden">
                <button onclick="startGame()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg text-lg animate-pulse">
                    INICIAR PARTIDA
                </button>
            </div>
            <p id="waitMsg" class="text-yellow-200/50 mt-4 text-sm italic">Solo el anfitri칩n puede iniciar.</p>
        </div>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div id="gameScreen" class="hidden h-full flex flex-col relative">
        <!-- Header -->
        <div class="bg-black/40 p-2 flex justify-between items-center px-4 z-10">
            <div class="font-bold text-yellow-400">Sala: <span id="gameRoomCode"></span></div>
            <div id="gameStatus" class="bg-gray-700 px-4 py-1 rounded-full text-sm font-bold">Esperando...</div>
        </div>

        <!-- Tablero -->
        <div class="flex-1 flex flex-col relative p-2">
            
            <!-- Zona de Avisos Sistema -->
            <div id="systemMsg" class="absolute top-12 left-0 right-0 text-center pointer-events-none z-20">
                <span class="bg-black/60 text-yellow-200 px-4 py-2 rounded-full text-sm shadow-lg backdrop-blur hidden"></span>
            </div>

            <!-- 츼rea Central: Mazo y Descarte -->
            <div class="flex-1 flex justify-center items-center gap-8 md:gap-16">
                <!-- Mazo -->
                <div class="relative">
                    <div class="w-24 h-36 bg-blue-900 border-2 border-white rounded-lg shadow-xl flex items-center justify-center bg-[url('img/reverso.png')] bg-cover bg-center">
                        <span id="deckCount" class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow">40</span>
                    </div>
                </div>

                <!-- Descarte / Carta Activa -->
                <div class="relative">
                    <div id="discardPile" class="w-24 h-36 border-2 border-dashed border-white/30 rounded-lg flex items-center justify-center transition-all duration-300">
                        <span class="text-white/30 text-xs">Descarte</span>
                    </div>
                    
                    <!-- Botones de Acci칩n (Tomar/Pasar) -->
                    <div id="actionButtons" class="hidden absolute -bottom-16 left-1/2 transform -translate-x-1/2 flex gap-2 w-max z-30">
                        <button onclick="respondOffer('take')" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded shadow font-bold text-sm">TOMAR</button>
                        <button onclick="respondOffer('pass')" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded shadow font-bold text-sm">PASAR</button>
                    </div>
                </div>
            </div>

            <!-- Mano del Jugador (CORREGIDO: z-index din치mico y ID a침adido) -->
            <div id="handContainer" class="h-40 flex flex-col justify-end pb-2 relative z-0">
                <p id="handInstruction" class="text-center text-xs text-yellow-200/70 mb-1">Tu Mano</p>
                <div id="myHand" class="flex justify-center -space-x-4 overflow-visible px-4 min-h-[120px]"></div>
            </div>
        </div>

        <!-- Overlay de Intercambio (z-50) -->
        <div id="exchangeOverlay" class="hidden absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center">
            <h2 class="text-3xl text-yellow-400 font-bold mb-4">Fase de Intercambio</h2>
            <p id="exchangeText" class="text-white mb-8 text-center max-w-md">Selecciona una carta de tu mano (abajo) para pasarla al jugador de tu derecha.</p>
            <div id="exchangeArrow" class="animate-bounce text-yellow-500 text-2xl"><i class="fas fa-arrow-down"></i></div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI칍N ---
        const SERVER_URL = 'https://conquian.onrender.com';
        const socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });

        let myState = {
            alias: '',
            roomCode: '',
            isHost: false,
            hand: [],
            phase: 'LOBBY', 
            isMyTurn: false
        };

        // --- DOM Elements ---
        const els = {
            login: document.getElementById('loginScreen'),
            lobby: document.getElementById('lobbyScreen'),
            game: document.getElementById('gameScreen'),
            error: document.getElementById('errorMsg'),
            lobbyList: document.getElementById('lobbyList'),
            hostControls: document.getElementById('hostControls'),
            hand: document.getElementById('myHand'),
            handContainer: document.getElementById('handContainer'), // Nuevo
            discard: document.getElementById('discardPile'),
            status: document.getElementById('gameStatus'),
            actions: document.getElementById('actionButtons'),
            sysMsg: document.getElementById('systemMsg').firstElementChild,
            exchangeOverlay: document.getElementById('exchangeOverlay'),
            exchangeText: document.getElementById('exchangeText'),
            exchangeArrow: document.getElementById('exchangeArrow')
        };

        // --- SOCKET EVENTS ---

        socket.on('room_created', data => {
            myState.roomCode = data.roomCode;
            myState.alias = data.alias;
            myState.isHost = data.isHost;
            renderLobbyList(data.players);
            showLobby();
        });

        socket.on('player_joined', data => {
            if (data.alias === myState.alias) {
                myState.roomCode = data.roomCode;
                showLobby();
            }
            if (data.players) renderLobbyList(data.players);
            showMsg(`${data.alias} entr칩.`);
        });

        socket.on('lobby_update', data => {
            renderLobbyList(data.players);
        });

        socket.on('game_start_exchange', data => {
            myState.hand = data.hand;
            myState.phase = 'EXCHANGE';
            showGame();
            
            // CORRECCI칍N VISUAL: Mostrar overlay y levantar la mano por encima
            els.exchangeOverlay.classList.remove('hidden');
            els.handContainer.classList.remove('z-0');
            els.handContainer.classList.add('z-[60]'); // Encima del overlay (z-50)
            
            els.exchangeText.innerText = "Selecciona una carta de tu mano para pasarla a la derecha.";
            els.exchangeArrow.classList.remove('hidden');
            
            renderHand();
            showMsg("춰Intercambio de cartas!");
        });

        socket.on('exchange_wait', data => {
            // Usuario ya seleccion칩
            els.exchangeText.innerHTML = `<span class="text-2xl animate-pulse">${data.msg}</span>`;
            els.exchangeArrow.classList.add('hidden');
            // Ya no dejamos clickear m치s
            els.handContainer.classList.remove('z-[60]');
            els.handContainer.classList.add('z-0');
        });

        socket.on('exchange_complete', data => {
            myState.hand = data.newHand;
            els.exchangeOverlay.classList.add('hidden');
            
            // RESET: Volver a normalidad
            els.handContainer.classList.remove('z-[60]');
            els.handContainer.classList.add('z-0');

            showMsg(`Recibiste: ${translateRank(data.receivedCard.rank)} de ${data.receivedCard.suit}`);
            renderHand();
        });

        socket.on('game_state_update', data => {
            updateGameState(data);
        });

        socket.on('hand_update', data => {
            myState.hand = data.hand;
            renderHand();
        });

        socket.on('system_msg', data => {
            showMsg(data.msg);
        });

        socket.on('error', data => {
            els.error.innerText = data.msg;
            const btn = document.getElementById('btnJoin');
            if(btn) { btn.disabled = false; btn.innerText = "Entrar"; }
            setTimeout(() => els.error.innerText = '', 3000);
        });

        // --- FUNCIONES LOGICA ---

        function createRoom() {
            const alias = document.getElementById('aliasInput').value;
            if(!alias) { els.error.innerText = "Ingresa un alias"; return; }
            socket.emit('create_room', { alias });
        }

        function joinRoom() {
            const alias = document.getElementById('aliasInput').value;
            const code = document.getElementById('roomCodeInput').value;
            if(!alias || !code) { els.error.innerText = "Faltan datos"; return; }
            const btn = document.getElementById('btnJoin');
            btn.disabled = true;
            btn.innerText = "Entrando...";
            myState.alias = alias;
            socket.emit('join_room', { alias, roomCode: code });
        }

        function startGame() {
            socket.emit('start_game_request', { roomCode: myState.roomCode });
        }

        function updateGameState(data) {
            myState.phase = data.phase;
            const activeId = data.activePlayerId;
            const amIActive = (activeId === socket.id);
            
            document.getElementById('deckCount').innerText = data.deckCount;
            
            const discardEl = els.discard;
            discardEl.innerHTML = '';
            
            if (data.topCard) {
                discardEl.appendChild(createCardEl(data.topCard, false));
                if (data.phase === 'OFFER') {
                    discardEl.firstElementChild.classList.add('glow-card');
                }
            } else {
                discardEl.innerHTML = '<span class="text-white/30 text-xs">Vac칤o</span>';
            }

            els.actions.classList.add('hidden');
            els.handInstruction.innerText = "Tu Mano";

            if (data.phase === 'OFFER') {
                if (amIActive) {
                    els.status.innerText = "游댮 쯈UIERES LA CARTA?";
                    els.status.className = "bg-red-600 px-4 py-1 rounded-full text-sm font-bold animate-pulse";
                    els.actions.classList.remove('hidden');
                } else {
                    els.status.innerText = `Esperando a ${activeId === socket.id ? 'ti' : 'oponente'}...`;
                    els.status.className = "bg-gray-700 px-4 py-1 rounded-full text-sm";
                }
            } else if (data.phase === 'DISCARDING') {
                if (amIActive) {
                    els.status.innerText = "游릭 DESCARTA UNA CARTA";
                    els.status.className = "bg-green-600 px-4 py-1 rounded-full text-sm font-bold";
                    els.handInstruction.innerText = "Selecciona carta para descartar";
                } else {
                    els.status.innerText = "Oponente jugando...";
                    els.status.className = "bg-gray-700 px-4 py-1 rounded-full text-sm";
                }
            }
            myState.isMyTurn = amIActive;
        }

        function handleCardClick(cardId, element) {
            if (myState.phase === 'EXCHANGE') {
                if (confirm("쯇asar esta carta a la derecha?")) {
                    // Feedback visual inmediato
                    if(element) element.style.opacity = '0.5';
                    socket.emit('submit_exchange_card', { roomCode: myState.roomCode, cardId });
                }
            } else if (myState.phase === 'DISCARDING' && myState.isMyTurn) {
                socket.emit('discard_card', { roomCode: myState.roomCode, cardId });
            }
        }

        function respondOffer(action) {
            socket.emit('offer_response', { roomCode: myState.roomCode, action });
            els.actions.classList.add('hidden');
        }

        // --- RENDERIZADO ---

        function showLobby() {
            els.login.classList.add('hidden');
            els.lobby.classList.remove('hidden');
            document.getElementById('lobbyCode').innerText = myState.roomCode;
        }

        function renderLobbyList(players) {
            if (!players) return;
            els.lobbyList.innerHTML = players.map(p => 
                `<li class="flex justify-between border-b border-gray-700 py-1">
                    <span><i class="fas fa-user mr-2 text-yellow-500"></i>${p.alias} ${p.alias === myState.alias ? '(T칰)' : ''}</span>
                    ${p.isHost ? '<span class="text-xs bg-yellow-600 px-1 rounded">HOST</span>' : ''}
                </li>`
            ).join('');

            const me = players.find(p => p.alias === myState.alias);
            if (me && me.isHost) {
                myState.isHost = true;
                els.hostControls.classList.remove('hidden');
                document.getElementById('waitMsg').classList.add('hidden');
            }
        }

        function showGame() {
            els.lobby.classList.add('hidden');
            els.game.classList.remove('hidden');
            document.getElementById('gameRoomCode').innerText = myState.roomCode;
        }

        function renderHand() {
            els.hand.innerHTML = '';
            myState.hand.forEach(card => {
                const el = createCardEl(card, true);
                
                // Si estamos en intercambio, resaltar que son interactivos
                if (myState.phase === 'EXCHANGE') {
                    el.classList.add('exchange-highlight', 'cursor-pointer');
                }

                el.onclick = () => handleCardClick(card.id, el);
                els.hand.appendChild(el);
            });
        }

        function createCardEl(card, interactive) {
            const el = document.createElement('div');
            const imageSrc = `img/${card.rank}-${card.suit}.png`;
            el.className = `card w-20 h-32 rounded-lg shadow-md bg-white relative flex items-center justify-center ${interactive ? 'cursor-pointer hover:border-yellow-400 border-2 border-transparent' : ''}`;
            
            el.innerHTML = `
                <img src="${imageSrc}" class="w-full h-full object-contain rounded-lg" onerror="this.nextElementSibling.classList.remove('hidden'); this.style.display='none'">
                <div class="hidden w-full h-full flex flex-col items-center justify-between p-1 rounded-lg ${getSuitColor(card.suit)}">
                    <div class="font-bold leading-none">${translateRank(card.rank)}</div>
                    <div class="text-2xl"><i class="${getSuitIcon(card.suit)}"></i></div>
                    <div class="font-bold leading-none rotate-180">${translateRank(card.rank)}</div>
                </div>
            `;
            return el;
        }

        function showMsg(txt) {
            if (!txt) return;
            els.sysMsg.innerText = txt;
            els.sysMsg.classList.remove('hidden');
            els.sysMsg.parentElement.classList.remove('hidden');
            clearTimeout(window.msgTimeout);
            window.msgTimeout = setTimeout(() => {
                els.sysMsg.classList.add('hidden');
            }, 3000);
        }

        // Helpers
        function translateRank(r) { return r===10?'S':r===11?'C':r===12?'R':r; }
        function getSuitColor(s) { return s==='Oros'?'text-yellow-600':s==='Copas'?'text-red-600':s==='Espadas'?'text-blue-600':'text-green-700'; }
        function getSuitIcon(s) { return s==='Oros'?'fas fa-sun':s==='Copas'?'fas fa-wine-glass':s==='Espadas'?'fas fa-khanda':'fas fa-tree'; }

    </script>
</body>
</html>
